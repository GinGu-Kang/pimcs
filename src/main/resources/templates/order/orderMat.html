<!DOCTYPE html>
<html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    <meta charset="utf-8"/>
    <title>Cocoon</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://js.tosspayments.com/v1"></script>
</head>
<body>


<section>
    <h1>회원가입 페이지</h1>
</section>

<section style="display:flex;">

    <form name="signUp" th:action="@{/order/mat}" method="post">
        <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
        <section th:each="matCategory,i:${matCategoryList}">
            <p style="margin-bottom: 0px" th:text="${matCategory.getMatCategoryName()}+'&nbsp&nbsp' + ${matCategory.getMatInformation()}"></p>
            <p th:text="${matCategory.getMatPrice()}+'원'"> </p>
            <input th:name="'matCategoryIdList['+${i.index}+']'" type="hidden" th:value="${matCategory.getId()}">
            <input th:name="'matCategoryOrderList['+${i.index}+'].orderCnt'" type="number" min="0"><br>
        </section>

        <div>
            희망 배송일<br>
            <input type="date" id="hopeDate" min="2022-01-0" name="hopeDeliveryDate"><br>
            주문자 이름<br>
            <input type="text" name="depositerName"><br>
            <section class="postService">
                <input type="text" placeholder="우편번호" id="postCode" min="0" name="postCode">
                <input type="button" value="우편번호 찾기" onclick="searchPostCode()"><br>
                <input type="text" placeholder="주소" id="deliveryAddress" min="0" name="deliveryAddress">
                <input type="text" placeholder="상세 주소" id="detailAddress" name="detailAddress"><br>
            </section>
        </div>
        <input type="submit" th:value="주문완료">
    </form>

</section>
<section><p id="price">hihi</p><button id="payment-button" onclick="iamport()" >구매</button>
</section>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    let date = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 10);
    $("#hopeDate").prop("min",date);
    function searchPostCode(){
        new daum.Postcode({
            oncomplete: function(data) {
                $("#postCode").prop("value",data.zonecode);
                $("#deliveryAddress").prop("value",data.address);
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분입니다.
                // 예제를 참고하여 다양한 활용법을 확인해 보세요.
            }
        }).open();

    }
</script>

<script>
    function getUUID() { // UUID v4 generator in JavaScript (RFC4122 compliant)
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 3 | 8);
            return v.toString(16);
        });
    }
    console.log(getUUID());

    function iamport(){

        //가맹점 식별코드
        IMP.init('imp57842343');
        IMP.request_pay({
            pg : 'uplus',
            pay_method : 'card',
            merchant_uid: getUUID(), //상점에서 생성한 고유 주문번호
            name : '주문명:결제테스트',
            amount : 14000,
            buyer_email : 'iamport@siot.do',
            buyer_name : '구매자이름',
            buyer_tel : '010-1234-5678',
            buyer_addr : '서울특별시 강남구 삼성동',
            buyer_postcode : '123-456',
            m_redirect_url : '{모바일에서 결제 완료 후 리디렉션 될 URL}' // 예: https://www.my-service.com/payments/complete/mobile
        }, function(rsp) {
            console.log(rsp);
            if ( rsp.success ) {
                var msg = '결제가 완료되었습니다.';
                msg += '고유ID : ' + rsp.imp_uid;
                msg += '상점 거래ID : ' + rsp.merchant_uid;
                msg += '결제 금액 : ' + rsp.paid_amount;
                msg += '카드 승인번호 : ' + rsp.apply_num;
            } else {
                var msg = '결제에 실패하였습니다.';
                msg += '에러내용 : ' + rsp.error_msg;
            }
            alert(msg);
        });
    }
</script>

</body>
</html>